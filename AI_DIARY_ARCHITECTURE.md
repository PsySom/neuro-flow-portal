# AI –î–Ω–µ–≤–Ω–∏–∫ - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
4. [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã](#–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
5. [–°–µ—Ä–≤–∏—Å—ã](#—Å–µ—Ä–≤–∏—Å—ã)
6. [–•—É–∫–∏](#—Ö—É–∫–∏)
7. [–¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö](#—Ç–∏–ø—ã-–¥–∞–Ω–Ω—ã—Ö)
8. [Realtime Architecture](#realtime-architecture)
9. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
10. [–°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#—Å—Ü–µ–Ω–∞—Ä–∏–∏-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
11. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)

---

## –û–±–∑–æ—Ä

AI –î–Ω–µ–≤–Ω–∏–∫ - —ç—Ç–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –≤–µ–¥–µ–Ω–∏—è —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–Ω–µ–≤–Ω–∏–∫–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Realtime –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É Supabase –±–µ–∑ –ø—Ä—è–º—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –∫ –≤–Ω–µ—à–Ω–∏–º AI API.

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- ü§ñ **AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç**: –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –∏ —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑–∞
- üí¨ **Realtime —á–∞—Ç**: –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ WebSocket
- üìä **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞**: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–π, —Ç–æ–ø–∏–∫–∏, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: RLS –ø–æ–ª–∏—Ç–∏–∫–∏, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- üì± **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å**: –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –û–±—â–∞—è —Å—Ö–µ–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  React Frontend ‚îÇ
‚îÇ   (FreeChat)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îú‚îÄ‚îÄ‚îÄ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
         ‚îÇ    ‚îî‚îÄ> Supabase: INSERT ai_diary_messages (user message)
         ‚îÇ
         ‚îú‚îÄ‚îÄ‚îÄ Database Trigger
         ‚îÇ    ‚îî‚îÄ> send_ai_diary_to_n8n() 
         ‚îÇ        ‚îî‚îÄ> Webhook: https://mentalbalans.com/webhook/ai-diary-chat
         ‚îÇ
         ‚îú‚îÄ‚îÄ‚îÄ n8n –æ–±—Ä–∞–±–æ—Ç–∫–∞
         ‚îÇ    ‚îú‚îÄ> OpenAI API
         ‚îÇ    ‚îî‚îÄ> INSERT ai_diary_messages (AI response)
         ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ Realtime –ø–æ–¥–ø–∏—Å–∫–∞
              ‚îî‚îÄ> onNewMessage() ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
```

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

**Frontend:**
- React 18.3
- TypeScript
- Tailwind CSS
- Radix UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- React Query –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

**Backend:**
- Supabase PostgreSQL
- Supabase Realtime (WebSockets)
- Database Triggers
- Row Level Security

**External:**
- n8n workflow automation
- OpenAI API (—á–µ—Ä–µ–∑ n8n)

---

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞: `ai_diary_sessions`

–•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```sql
CREATE TABLE ai_diary_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  session_id VARCHAR NOT NULL DEFAULT gen_random_uuid()::text,
  started_at TIMESTAMPTZ DEFAULT now(),
  ended_at TIMESTAMPTZ,
  summary TEXT,
  insights JSONB DEFAULT '{}',
  emotional_state JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT now()
);
```

**–ü–æ–ª—è:**
- `id` - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏
- `user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–≤—è–∑—å —Å auth.users)
- `session_id` - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ—Å—Å–∏–∏ (—Å—Ç—Ä–æ–∫–∞)
- `started_at` - –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Å–µ—Å—Å–∏–∏
- `ended_at` - –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ (NULL –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞)
- `summary` - –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
- `insights` - –ò–Ω—Å–∞–π—Ç—ã –∏ –≤—ã–≤–æ–¥—ã (JSON)
- `emotional_state` - –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (JSON)

**RLS –ü–æ–ª–∏—Ç–∏–∫–∏:**
```sql
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–µ—Å—Å–∏–∏
CREATE POLICY "Users can view their own diary sessions"
  ON ai_diary_sessions FOR SELECT
  USING (auth.uid() = user_id);

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ–∑–¥–∞—é—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–µ—Å—Å–∏–∏
CREATE POLICY "Users can create their own diary sessions"
  ON ai_diary_sessions FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–µ—Å—Å–∏–∏
CREATE POLICY "Users can update their own diary sessions"
  ON ai_diary_sessions FOR UPDATE
  USING (auth.uid() = user_id);

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–¥–∞–ª—è—é—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–µ—Å—Å–∏–∏
CREATE POLICY "Users can delete their own diary sessions"
  ON ai_diary_sessions FOR DELETE
  USING (auth.uid() = user_id);
```

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_ai_diary_sessions_user_id ON ai_diary_sessions(user_id);
CREATE INDEX idx_ai_diary_sessions_session_id ON ai_diary_sessions(session_id);
CREATE INDEX idx_ai_diary_sessions_started_at ON ai_diary_sessions(started_at DESC);
```

---

### –¢–∞–±–ª–∏—Ü–∞: `ai_diary_messages`

–•—Ä–∞–Ω–∏—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ AI.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```sql
CREATE TABLE ai_diary_messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  session_id VARCHAR,
  message_type VARCHAR, -- 'user' | 'ai'
  content TEXT NOT NULL,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT now()
);
```

**–ü–æ–ª—è:**
- `id` - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è
- `user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `session_id` - ID —Å–µ—Å—Å–∏–∏ (—Å–≤—è–∑—å —Å ai_diary_sessions)
- `message_type` - –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: 'user' –∏–ª–∏ 'ai'
- `content` - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- `metadata` - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (timestamp, source, suggestions)
- `created_at` - –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è

**RLS –ü–æ–ª–∏—Ç–∏–∫–∏:**
```sql
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
CREATE POLICY "Users can view their own diary messages"
  ON ai_diary_messages FOR SELECT
  USING (auth.uid() = user_id);

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ–∑–¥–∞—é—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
CREATE POLICY "Users can create their own diary messages"
  ON ai_diary_messages FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
CREATE POLICY "Users can update their own diary messages"
  ON ai_diary_messages FOR UPDATE
  USING (auth.uid() = user_id);

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–¥–∞–ª—è—é—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
CREATE POLICY "Users can delete their own diary messages"
  ON ai_diary_messages FOR DELETE
  USING (auth.uid() = user_id);
```

**–ò–Ω–¥–µ–∫—Å—ã:**
```sql
CREATE INDEX idx_ai_diary_messages_user_id ON ai_diary_messages(user_id);
CREATE INDEX idx_ai_diary_messages_session_id ON ai_diary_messages(session_id);
CREATE INDEX idx_ai_diary_messages_created_at ON ai_diary_messages(created_at DESC);
CREATE INDEX idx_ai_diary_messages_type ON ai_diary_messages(message_type);
```

---

### Database Triggers

**Trigger: –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ n8n**

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç—Ä–∏–≥–≥–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ n8n webhook.

```sql
CREATE OR REPLACE FUNCTION send_ai_diary_to_n8n()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.message_type = 'user' THEN
    PERFORM net.http_post(
      url := 'https://mentalbalans.com/webhook/ai-diary-chat',
      headers := '{"Content-Type": "application/json"}'::jsonb,
      body := jsonb_build_object(
        'user_id', NEW.user_id,
        'session_id', NEW.session_id,
        'message', NEW.content,
        'message_id', NEW.id,
        'timestamp', NEW.created_at
      )
    );
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER trigger_send_ai_diary_to_n8n
  AFTER INSERT ON ai_diary_messages
  FOR EACH ROW
  EXECUTE FUNCTION send_ai_diary_to_n8n();
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
2. INSERT –≤ `ai_diary_messages` —Å `message_type = 'user'`
3. –¢—Ä–∏–≥–≥–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç AFTER INSERT
4. –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç HTTP POST –Ω–∞ webhook
5. n8n –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏—Ö

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –ò–µ—Ä–∞—Ä—Ö–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```
AIDiaryScenarios (src/components/dashboard/AIDiaryScenarios.tsx)
  ‚îî‚îÄ> AIDiaryContainer (ai-diary-scenarios/AIDiaryContainer.tsx)
      ‚îî‚îÄ> FreeChat (ai-diary-scenarios/FreeChat.tsx)
          ‚îú‚îÄ> FreeChatHeader (ai-diary-scenarios/FreeChatHeader.tsx)
          ‚îú‚îÄ> AIDiaryStats (ai-diary-scenarios/AIDiaryStats.tsx)
          ‚îú‚îÄ> FreeChatMessages (ai-diary-scenarios/FreeChatMessages.tsx)
          ‚îÇ   ‚îî‚îÄ> ChatMessage (ai-diary-scenarios/ChatMessage.tsx)
          ‚îî‚îÄ> FreeChatInput (ai-diary-scenarios/FreeChatInput.tsx)
```

---

### FreeChat.tsx

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/components/dashboard/ai-diary-scenarios/FreeChat.tsx`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç AI –¥–Ω–µ–≤–Ω–∏–∫–∞, —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏ UI.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
```typescript
const FreeChat = () => {
  // –•—É–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–æ–º
  const {
    chatMessages,
    chatInput,
    setChatInput,
    isAITyping,
    isLoading,
    currentSessionId,
    handleSendMessage,
    handleNewSession,
    handleEndSession,
    handleSuggestionClick,
    isUserAuthenticated,
    loadingHistory
  } = useAIDiaryChat();

  // –•—É–∫ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
  const { stats, topics, isLoadingStats } = useAIDiaryAnalytics();

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  const [isAuthenticated, setIsAuthenticated] = useState<null | boolean>(null);
  
  useEffect(() => {
    isUserAuthenticated().then(setIsAuthenticated);
  }, [isUserAuthenticated]);

  // –†–µ–Ω–¥–µ—Ä UI
  return (
    <Card>
      <FreeChatHeader 
        onNewSession={handleNewSession}
        onEndSession={handleEndSession}
        currentSessionId={currentSessionId}
      />
      <AIDiaryStats stats={stats} topics={topics} />
      <FreeChatMessages 
        messages={chatMessages}
        isLoading={isLoading}
        isAITyping={isAITyping}
        onSuggestionClick={handleSuggestionClick}
      />
      <FreeChatInput 
        value={chatInput}
        onChange={setChatInput}
        onSend={handleSendMessage}
        disabled={isLoading || isAITyping}
      />
    </Card>
  );
};
```

**State —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- `chatMessages` - –º–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞
- `chatInput` - —Ç–µ–∫—É—â–∏–π –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `isAITyping` - —Ñ–ª–∞–≥ –ø–µ—á–∞—Ç–∞–Ω–∏—è AI
- `isLoading` - —Ñ–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏
- `currentSessionId` - ID —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏

---

### FreeChatMessages.tsx

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/components/dashboard/ai-diary-scenarios/FreeChatMessages.tsx`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª–æ–º.

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
```typescript
const FreeChatMessages: React.FC<FreeChatMessagesProps> = ({
  messages,
  isLoading,
  isAITyping,
  onSuggestionClick
}) => {
  const scrollAreaRef = useRef<HTMLDivElement>(null);
  const [copiedMessageId, setCopiedMessageId] = useState<string | null>(null);

  // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
  const scrollToBottom = useCallback(() => {
    if (scrollAreaRef.current) {
      const viewport = scrollAreaRef.current.querySelector(
        '[data-radix-scroll-area-viewport]'
      ) as HTMLElement;
      
      if (viewport) {
        requestAnimationFrame(() => {
          viewport.scrollTo({
            top: viewport.scrollHeight,
            behavior: 'smooth'
          });
        });
      }
    }
  }, []);

  // –°–∫—Ä–æ–ª–ª –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
  useEffect(() => {
    scrollToBottom();
  }, [messages, isAITyping, scrollToBottom]);

  // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
  const copyToClipboard = async (content: string, messageId: string) => {
    try {
      await navigator.clipboard.writeText(content);
      setCopiedMessageId(messageId);
      toast.success('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
      setTimeout(() => setCopiedMessageId(null), 2000);
    } catch (error) {
      toast.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
    }
  };

  return (
    <ScrollArea ref={scrollAreaRef}>
      {messages.map((message) => (
        <div key={message.id} className="message-container">
          <Avatar>
            {message.type === 'user' ? <User /> : <Bot />}
          </Avatar>
          <div className="message-content">
            <Markdown>{message.content}</Markdown>
            {message.suggestions && (
              <div className="suggestions">
                {message.suggestions.map((suggestion, idx) => (
                  <Button 
                    key={idx}
                    onClick={() => onSuggestionClick(suggestion)}
                  >
                    {suggestion}
                  </Button>
                ))}
              </div>
            )}
          </div>
          <Button onClick={() => copyToClipboard(message.content, message.id)}>
            <Copy />
          </Button>
        </div>
      ))}
      
      {isAITyping && <TypingIndicator />}
    </ScrollArea>
  );
};
```

---

### FreeChatInput.tsx

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/components/dashboard/ai-diary-scenarios/FreeChatInput.tsx`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞.

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
```typescript
const FreeChatInput: React.FC<FreeChatInputProps> = ({
  value,
  onChange,
  onSend,
  disabled
}) => {
  const textareaRef = useRef<HTMLTextAreaElement>(null);

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã
  useEffect(() => {
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto';
      textareaRef.current.style.height = 
        `${textareaRef.current.scrollHeight}px`;
    }
  }, [value]);

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter (—Å Shift –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)
  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (value.trim() && !disabled) {
        onSend();
      }
    }
  };

  return (
    <div className="input-container">
      <Textarea
        ref={textareaRef}
        value={value}
        onChange={(e) => onChange(e.target.value)}
        onKeyDown={handleKeyDown}
        placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
        disabled={disabled}
        rows={1}
      />
      <Button 
        onClick={onSend}
        disabled={!value.trim() || disabled}
      >
        <Send />
      </Button>
    </div>
  );
};
```

---

### FreeChatHeader.tsx

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/components/dashboard/ai-diary-scenarios/FreeChatHeader.tsx`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–µ–π.

```typescript
const FreeChatHeader: React.FC<FreeChatHeaderProps> = ({
  onNewSession,
  onEndSession,
  currentSessionId
}) => {
  return (
    <CardHeader>
      <div className="flex justify-between items-center">
        <div>
          <CardTitle>AI –î–Ω–µ–≤–Ω–∏–∫</CardTitle>
          <CardDescription>
            –û–±—â–∞–π—Ç–µ—Å—å —Å AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º –¥–ª—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏
          </CardDescription>
        </div>
        <div className="flex gap-2">
          {currentSessionId && (
            <Button variant="outline" onClick={onEndSession}>
              –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é
            </Button>
          )}
          <Button onClick={onNewSession}>
            –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è
          </Button>
        </div>
      </div>
    </CardHeader>
  );
};
```

---

### AIDiaryStats.tsx

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/components/dashboard/ai-diary-scenarios/AIDiaryStats.tsx`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–Ω–µ–≤–Ω–∏–∫–∞.

```typescript
interface AIDiaryStatsProps {
  stats: SessionStats | null;
  topics: TopicFrequency[];
  isLoading?: boolean;
}

const AIDiaryStats: React.FC<AIDiaryStatsProps> = ({
  stats,
  topics,
  isLoading
}) => {
  if (isLoading) return <Skeleton />;
  if (!stats) return null;

  return (
    <div className="stats-container">
      <div className="stat-card">
        <span>–í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π</span>
        <span>{stats.totalSessions}</span>
      </div>
      <div className="stat-card">
        <span>–°–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Å–µ—Å—Å–∏—é</span>
        <span>{stats.averageMessagesPerSession.toFixed(1)}</span>
      </div>
      <div className="stat-card">
        <span>–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</span>
        <span>{stats.totalMessages}</span>
      </div>
      
      {topics.length > 0 && (
        <div className="topics">
          <h4>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–º—ã:</h4>
          {topics.map(topic => (
            <Badge key={topic.topic}>
              {topic.topic} ({topic.count})
            </Badge>
          ))}
        </div>
      )}
    </div>
  );
};
```

---

## –°–µ—Ä–≤–∏—Å—ã

### AIDiaryService

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/services/ai-diary.service.ts`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AI –¥–Ω–µ–≤–Ω–∏–∫–æ–º.

**–ú–µ—Ç–æ–¥—ã:**

#### `ensureSessionExists(sessionId: string): Promise<void>`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –∏ —Å–æ–∑–¥–∞–µ—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.

```typescript
async ensureSessionExists(sessionId: string): Promise<void> {
  if (!this.userId) return;
  
  const { data: existing } = await supabase
    .from('ai_diary_sessions')
    .select('id')
    .eq('session_id', sessionId)
    .single();
    
  if (!existing) {
    await supabase.from('ai_diary_sessions').insert({
      user_id: this.userId,
      session_id: sessionId,
      started_at: new Date().toISOString()
    });
  }
}
```

#### `getCurrentSessionId(): string | null`
–ü–æ–ª—É—á–∞–µ—Ç ID —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏ –∏–∑ localStorage.

```typescript
getCurrentSessionId(): string | null {
  return localStorage.getItem('ai_diary_session_id');
}
```

#### `subscribeToMessages(sessionId, onNewMessage): RealtimeChannel`
–ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –Ω–æ–≤—ã–µ AI —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ Realtime.

```typescript
subscribeToMessages(sessionId: string, onNewMessage: (message: any) => void) {
  if (this.realtimeChannel) {
    this.realtimeChannel.unsubscribe();
  }
  
  this.realtimeChannel = supabase
    .channel(`ai_diary_${sessionId}`)
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'ai_diary_messages',
        filter: `session_id=eq.${sessionId}`
      },
      (payload) => {
        if (payload.new.message_type === 'ai') {
          onNewMessage(payload.new);
        }
      }
    )
    .subscribe();
    
  return this.realtimeChannel;
}
```

#### `sendMessage(message: string, sessionId: string): Promise<any>`
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

```typescript
async sendMessage(message: string, sessionId: string): Promise<any> {
  if (!this.userId) {
    const { data: { user } } = await supabase.auth.getUser();
    this.userId = user?.id || null;
  }
  
  if (!this.userId) {
    throw new Error('User not authenticated');
  }
  
  try {
    await this.ensureSessionExists(sessionId);
    
    const { data, error } = await supabase
      .from('ai_diary_messages')
      .insert({
        user_id: this.userId,
        session_id: sessionId,
        message_type: 'user',
        content: message,
        metadata: {
          timestamp: new Date().toISOString(),
          source: 'free_chat'
        }
      })
      .select()
      .single();
      
    if (error) throw error;
    
    return { 
      success: true, 
      messageId: data.id,
      ai_response: 'AI –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...',
      session_id: sessionId 
    };
  } catch (error) {
    console.error('Error sending message:', error);
    return { 
      success: false, 
      error: error.message,
      ai_response: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è'
    };
  }
}
```

#### `loadSessionHistory(sessionId: string): Promise<any[]>`
–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π —Å–µ—Å—Å–∏–∏.

```typescript
async loadSessionHistory(sessionId: string): Promise<any[]> {
  const { data, error } = await supabase
    .from('ai_diary_messages')
    .select('*')
    .eq('session_id', sessionId)
    .order('created_at', { ascending: true });
    
  if (error) {
    console.error('Error loading history:', error);
    return [];
  }
  
  return data || [];
}
```

#### `startNewSession(): Promise<string>`
–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é.

```typescript
async startNewSession(): Promise<string> {
  const newSessionId = `ai_diary_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  localStorage.setItem('ai_diary_session_id', newSessionId);
  
  if (this.userId) {
    await supabase.from('ai_diary_sessions').insert({
      user_id: this.userId,
      session_id: newSessionId,
      started_at: new Date().toISOString()
    });
  }
  
  return newSessionId;
}
```

#### `endSession(sessionId: string): Promise<void>`
–ó–∞–≤–µ—Ä—à–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é.

```typescript
async endSession(sessionId: string): Promise<void> {
  if (this.userId && sessionId) {
    await supabase
      .from('ai_diary_sessions')
      .update({ ended_at: new Date().toISOString() })
      .eq('session_id', sessionId);
  }
  
  localStorage.removeItem('ai_diary_session_id');
  this.unsubscribe();
}
```

#### `unsubscribe(): void`
–û—Ç–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –æ—Ç Realtime –∫–∞–Ω–∞–ª–∞.

```typescript
unsubscribe() {
  if (this.realtimeChannel) {
    this.realtimeChannel.unsubscribe();
    this.realtimeChannel = null;
  }
}
```

---

### AIDiaryAnalyticsService

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/services/ai-diary-analytics.service.ts`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–µ—Ä–≤–∏—Å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–Ω–µ–≤–Ω–∏–∫–∞.

**–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã:**

```typescript
interface SessionStats {
  totalSessions: number;
  averageMessagesPerSession: number;
  totalMessages: number;
  currentSession?: {
    duration: string;
    messageCount: number;
    averageMessageLength: number;
  };
}

interface TopicFrequency {
  topic: string;
  count: number;
}
```

**–ú–µ—Ç–æ–¥—ã:**

#### `getUserStats(userId: string): Promise<SessionStats | null>`
–ü–æ–ª—É—á–∞–µ—Ç –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

```typescript
async getUserStats(userId: string): Promise<SessionStats | null> {
  try {
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–µ—Å—Å–∏–∏
    const { data: sessions } = await supabase
      .from('ai_diary_sessions')
      .select('id, session_id')
      .eq('user_id', userId);
    
    if (!sessions || sessions.length === 0) {
      return {
        totalSessions: 0,
        averageMessagesPerSession: 0,
        totalMessages: 0
      };
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    const { data: messages } = await supabase
      .from('ai_diary_messages')
      .select('id')
      .eq('user_id', userId);
    
    const totalMessages = messages?.length || 0;
    const totalSessions = sessions.length;
    const averageMessagesPerSession = totalSessions > 0 
      ? totalMessages / totalSessions 
      : 0;
    
    return {
      totalSessions,
      averageMessagesPerSession,
      totalMessages
    };
  } catch (error) {
    console.error('Error getting user stats:', error);
    return null;
  }
}
```

#### `getCurrentSessionStats(sessionId, userId, currentMessages): Promise<Partial<SessionStats>>`
–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏.

```typescript
async getCurrentSessionStats(
  sessionId: string, 
  userId: string, 
  currentMessages: any[]
): Promise<Partial<SessionStats>> {
  try {
    const { data: session } = await supabase
      .from('ai_diary_sessions')
      .select('started_at')
      .eq('session_id', sessionId)
      .eq('user_id', userId)
      .single();
    
    if (!session) return {};
    
    const startTime = new Date(session.started_at);
    const now = new Date();
    const durationMinutes = Math.floor((now.getTime() - startTime.getTime()) / 60000);
    
    const userMessages = currentMessages.filter(m => m.type === 'user');
    const totalLength = userMessages.reduce((sum, m) => sum + m.content.length, 0);
    const averageLength = userMessages.length > 0 
      ? Math.round(totalLength / userMessages.length) 
      : 0;
    
    return {
      currentSession: {
        duration: this.formatDuration(durationMinutes),
        messageCount: currentMessages.length,
        averageMessageLength: averageLength
      }
    };
  } catch (error) {
    console.error('Error getting current session stats:', error);
    return {};
  }
}
```

#### `getTopTopics(userId: string, limit: number = 5): Promise<TopicFrequency[]>`
–ü–æ–ª—É—á–∞–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ –æ–±—Å—É–∂–¥–∞–µ–º—ã–µ —Ç–µ–º—ã.

```typescript
async getTopTopics(userId: string, limit: number = 5): Promise<TopicFrequency[]> {
  try {
    const { data: messages } = await supabase
      .from('ai_diary_messages')
      .select('content')
      .eq('user_id', userId)
      .eq('message_type', 'user');
    
    if (!messages) return [];
    
    // –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    const keywords = [
      '—Ç—Ä–µ–≤–æ–≥–∞', '—Å—Ç—Ä–µ—Å—Å', '—Å–æ–Ω', '–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ', '–¥–µ–ø—Ä–µ—Å—Å–∏—è',
      '—ç–Ω–µ—Ä–≥–∏—è', '–º–æ—Ç–∏–≤–∞—Ü–∏—è', '–æ—Ç–Ω–æ—à–µ–Ω–∏—è', '—Ä–∞–±–æ—Ç–∞', '—Å–∞–º–æ–æ—Ü–µ–Ω–∫–∞',
      '—Å—Ç—Ä–∞—Ö', '–∑–ª–æ—Å—Ç—å', '–≥—Ä—É—Å—Ç—å', '—Ä–∞–¥–æ—Å—Ç—å', '–±–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤–æ'
    ];
    
    const topicCounts: Record<string, number> = {};
    
    // –ü–æ–¥—Å—á–µ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏–π
    messages.forEach(message => {
      const content = message.content.toLowerCase();
      keywords.forEach(keyword => {
        if (content.includes(keyword)) {
          topicCounts[keyword] = (topicCounts[keyword] || 0) + 1;
        }
      });
    });
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
    return Object.entries(topicCounts)
      .map(([topic, count]) => ({ topic, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, limit);
  } catch (error) {
    console.error('Error getting top topics:', error);
    return [];
  }
}
```

#### `formatDuration(minutes: number): string`
–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥.

```typescript
private formatDuration(minutes: number): string {
  if (minutes < 60) {
    return `${minutes} –º–∏–Ω`;
  }
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return `${hours} —á ${mins} –º–∏–Ω`;
}
```

---

## –•—É–∫–∏

### useAIDiaryChat

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/components/dashboard/ai-diary-scenarios/hooks/useAIDiaryChat.ts`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ì–ª–∞–≤–Ω—ã–π —Ö—É–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–æ–º.

**–í–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:**

```typescript
interface UseAIDiaryChatReturn {
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ
  chatMessages: Message[];
  chatInput: string;
  isAITyping: boolean;
  isLoading: boolean;
  loadingHistory: boolean;
  currentSessionId: string | null;
  
  // –î–µ–π—Å—Ç–≤–∏—è
  setChatInput: (value: string) => void;
  handleSendMessage: () => Promise<void>;
  handleNewSession: () => Promise<void>;
  handleEndSession: () => Promise<void>;
  handleSuggestionClick: (suggestion: string) => void;
  isUserAuthenticated: () => Promise<boolean>;
}
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```typescript
export const useAIDiaryChat = (): UseAIDiaryChatReturn => {
  const [chatMessages, setChatMessages] = useState<Message[]>([]);
  const [chatInput, setChatInput] = useState('');
  const [isAITyping, setIsAITyping] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [loadingHistory, setLoadingHistory] = useState(true);
  const [currentSessionId, setCurrentSessionId] = useState<string | null>(null);
  
  const aiDiaryService = useMemo(() => new AIDiaryService(), []);

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏ –∏ –∏—Å—Ç–æ—Ä–∏–∏
  useEffect(() => {
    const initializeChat = async () => {
      setLoadingHistory(true);
      
      let sessionId = aiDiaryService.getCurrentSessionId();
      
      if (!sessionId) {
        sessionId = await aiDiaryService.startNewSession();
      }
      
      setCurrentSessionId(sessionId);
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
      const history = await aiDiaryService.loadSessionHistory(sessionId);
      const formattedMessages = history.map(msg => ({
        id: msg.id,
        type: msg.message_type,
        content: msg.content,
        timestamp: new Date(msg.created_at),
        suggestions: msg.metadata?.suggestions
      }));
      
      setChatMessages(formattedMessages);
      setLoadingHistory(false);
    };
    
    initializeChat();
  }, [aiDiaryService]);

  // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Realtime
  useEffect(() => {
    if (!currentSessionId) return;
    
    const channel = aiDiaryService.subscribeToMessages(
      currentSessionId,
      (newMessage) => {
        setIsAITyping(true);
        
        // –≠—Ñ—Ñ–µ–∫—Ç –ø–µ—á–∞—Ç–∞–Ω–∏—è
        let currentText = '';
        const fullText = newMessage.content;
        const typingSpeed = 20;
        
        const typingInterval = setInterval(() => {
          if (currentText.length < fullText.length) {
            currentText = fullText.slice(0, currentText.length + 1);
            
            setChatMessages(prev => {
              const filtered = prev.filter(m => m.id !== 'typing');
              return [
                ...filtered,
                {
                  id: 'typing',
                  type: 'ai',
                  content: currentText,
                  timestamp: new Date(),
                  suggestions: newMessage.metadata?.suggestions
                }
              ];
            });
          } else {
            clearInterval(typingInterval);
            setIsAITyping(false);
            
            // –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            setChatMessages(prev => {
              const filtered = prev.filter(m => m.id !== 'typing');
              return [
                ...filtered,
                {
                  id: newMessage.id,
                  type: 'ai',
                  content: fullText,
                  timestamp: new Date(newMessage.created_at),
                  suggestions: newMessage.metadata?.suggestions
                }
              ];
            });
          }
        }, typingSpeed);
      }
    );
    
    return () => {
      aiDiaryService.unsubscribe();
    };
  }, [currentSessionId, aiDiaryService]);

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  const handleSendMessage = useCallback(async () => {
    if (!chatInput.trim() || !currentSessionId || isLoading) return;
    
    const userMessage = chatInput.trim();
    setChatInput('');
    setIsLoading(true);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userMsg: Message = {
      id: `user-${Date.now()}`,
      type: 'user',
      content: userMessage,
      timestamp: new Date()
    };
    
    setChatMessages(prev => [...prev, userMsg]);
    
    try {
      await aiDiaryService.sendMessage(userMessage, currentSessionId);
    } catch (error) {
      console.error('Error sending message:', error);
      toast.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
    } finally {
      setIsLoading(false);
    }
  }, [chatInput, currentSessionId, isLoading, aiDiaryService]);

  // –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è
  const handleNewSession = useCallback(async () => {
    if (currentSessionId) {
      await aiDiaryService.endSession(currentSessionId);
    }
    
    const newSessionId = await aiDiaryService.startNewSession();
    setCurrentSessionId(newSessionId);
    setChatMessages([]);
    toast.success('–ù–∞—á–∞—Ç–∞ –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è');
  }, [currentSessionId, aiDiaryService]);

  // –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é
  const handleEndSession = useCallback(async () => {
    if (!currentSessionId) return;
    
    await aiDiaryService.endSession(currentSessionId);
    setCurrentSessionId(null);
    setChatMessages([]);
    toast.success('–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
  }, [currentSessionId, aiDiaryService]);

  // –ö–ª–∏–∫ –ø–æ suggestion
  const handleSuggestionClick = useCallback((suggestion: string) => {
    setChatInput(suggestion);
  }, []);

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  const isUserAuthenticated = useCallback(async () => {
    const { data: { user } } = await supabase.auth.getUser();
    return !!user;
  }, []);

  return {
    chatMessages,
    chatInput,
    isAITyping,
    isLoading,
    loadingHistory,
    currentSessionId,
    setChatInput,
    handleSendMessage,
    handleNewSession,
    handleEndSession,
    handleSuggestionClick,
    isUserAuthenticated
  };
};
```

---

### useAIDiaryAnalytics

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/components/dashboard/ai-diary-scenarios/hooks/useAIDiaryAnalytics.ts`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—É–∫ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.

```typescript
interface UseAIDiaryAnalyticsReturn {
  stats: SessionStats | null;
  topics: TopicFrequency[];
  isLoadingStats: boolean;
}

export const useAIDiaryAnalytics = (): UseAIDiaryAnalyticsReturn => {
  const [stats, setStats] = useState<SessionStats | null>(null);
  const [topics, setTopics] = useState<TopicFrequency[]>([]);
  const [isLoadingStats, setIsLoadingStats] = useState(true);
  
  const analyticsService = useMemo(() => new AIDiaryAnalyticsService(), []);

  useEffect(() => {
    const loadAnalytics = async () => {
      setIsLoadingStats(true);
      
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        setIsLoadingStats(false);
        return;
      }
      
      try {
        const [userStats, userTopics] = await Promise.all([
          analyticsService.getUserStats(user.id),
          analyticsService.getTopTopics(user.id, 5)
        ]);
        
        setStats(userStats);
        setTopics(userTopics);
      } catch (error) {
        console.error('Error loading analytics:', error);
      } finally {
        setIsLoadingStats(false);
      }
    };
    
    loadAnalytics();
  }, [analyticsService]);

  return {
    stats,
    topics,
    isLoadingStats
  };
};
```

---

## –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

### Message

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/components/dashboard/ai-diary-scenarios/chatTypes.ts`

```typescript
export interface Message {
  id: string;
  type: 'user' | 'ai';
  content: string;
  timestamp: Date;
  suggestions?: string[];
}
```

### SessionStats

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/services/ai-diary-analytics.service.ts`

```typescript
export interface SessionStats {
  totalSessions: number;
  averageMessagesPerSession: number;
  totalMessages: number;
  currentSession?: {
    duration: string;
    messageCount: number;
    averageMessageLength: number;
  };
}
```

### TopicFrequency

```typescript
export interface TopicFrequency {
  topic: string;
  count: number;
}
```

---

## Realtime Architecture

### –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã Realtime

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Frontend (React)                       ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  1. Component Mount                                        ‚îÇ
‚îÇ     ‚îî‚îÄ> useEffect: subscribeToMessages()                 ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  2. Supabase Realtime Channel                             ‚îÇ
‚îÇ     ‚îî‚îÄ> supabase.channel('ai_diary_${sessionId}')       ‚îÇ
‚îÇ         ‚îî‚îÄ> .on('postgres_changes', ...)                 ‚îÇ
‚îÇ             ‚îî‚îÄ> event: 'INSERT'                           ‚îÇ
‚îÇ             ‚îî‚îÄ> table: 'ai_diary_messages'               ‚îÇ
‚îÇ             ‚îî‚îÄ> filter: 'session_id=eq.${sessionId}'     ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  3. WebSocket Connection                                   ‚îÇ
‚îÇ     ‚îî‚îÄ> wss://szvousyzsqdpubgfycdy.supabase.co/realtime ‚îÇ
‚îÇ                                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 Supabase Realtime Server                  ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  - –°–ª—É—à–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö                       ‚îÇ
‚îÇ  - –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ session_id                               ‚îÇ
‚îÇ  - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ message_type = 'ai'                 ‚îÇ
‚îÇ                                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Frontend Callback                         ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  onNewMessage(payload.new)                                ‚îÇ
‚îÇ    ‚îÇ                                                       ‚îÇ
‚îÇ    ‚îú‚îÄ> setIsAITyping(true)                               ‚îÇ
‚îÇ    ‚îÇ                                                       ‚îÇ
‚îÇ    ‚îú‚îÄ> Typing Effect (20ms per character)                ‚îÇ
‚îÇ    ‚îÇ   ‚îî‚îÄ> –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞                ‚îÇ
‚îÇ    ‚îÇ                                                       ‚îÇ
‚îÇ    ‚îú‚îÄ> Parse Suggestions                                  ‚îÇ
‚îÇ    ‚îÇ   ‚îî‚îÄ> –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑ metadata                        ‚îÇ
‚îÇ    ‚îÇ                                                       ‚îÇ
‚îÇ    ‚îî‚îÄ> setChatMessages([...prev, newMessage])            ‚îÇ
‚îÇ                                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Realtime –≤ Supabase

**–í–∫–ª—é—á–µ–Ω–∏–µ Realtime –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã:**

```sql
-- –í–∫–ª—é—á–∏—Ç—å REPLICA IDENTITY FULL –¥–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç—Ä–æ–∫–∞—Ö
ALTER TABLE ai_diary_messages REPLICA IDENTITY FULL;

-- –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤ –ø—É–±–ª–∏–∫–∞—Ü–∏—é realtime
ALTER PUBLICATION supabase_realtime ADD TABLE ai_diary_messages;
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Realtime:**

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
SELECT * FROM pg_publication_tables WHERE pubname = 'supabase_realtime';

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å REPLICA IDENTITY
SELECT 
  schemaname, 
  tablename, 
  CASE relreplident
    WHEN 'd' THEN 'default'
    WHEN 'n' THEN 'nothing'
    WHEN 'f' THEN 'full'
    WHEN 'i' THEN 'index'
  END AS replica_identity
FROM pg_class
JOIN pg_namespace ON pg_class.relnamespace = pg_namespace.oid
WHERE relkind = 'r' AND schemaname = 'public';
```

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### n8n Workflow

**URL webhook:** `https://mentalbalans.com/webhook/ai-diary-chat`

**–°—Ö–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  n8n Workflow                            ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  1. Webhook Trigger                                      ‚îÇ
‚îÇ     ‚îî‚îÄ> POST /webhook/ai-diary-chat                     ‚îÇ
‚îÇ         ‚îú‚îÄ> user_id                                      ‚îÇ
‚îÇ         ‚îú‚îÄ> session_id                                   ‚îÇ
‚îÇ         ‚îú‚îÄ> message                                      ‚îÇ
‚îÇ         ‚îú‚îÄ> message_id                                   ‚îÇ
‚îÇ         ‚îî‚îÄ> timestamp                                    ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  2. Load Message History                                 ‚îÇ
‚îÇ     ‚îî‚îÄ> Supabase Query                                   ‚îÇ
‚îÇ         SELECT * FROM ai_diary_messages                  ‚îÇ
‚îÇ         WHERE session_id = {{$json.session_id}}          ‚îÇ
‚îÇ         ORDER BY created_at ASC                          ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  3. Format Messages for OpenAI                           ‚îÇ
‚îÇ     ‚îî‚îÄ> Transform to OpenAI format                       ‚îÇ
‚îÇ         [                                                 ‚îÇ
‚îÇ           { role: "system", content: "..." },            ‚îÇ
‚îÇ           { role: "user", content: "..." },              ‚îÇ
‚îÇ           { role: "assistant", content: "..." },         ‚îÇ
‚îÇ           ...                                             ‚îÇ
‚îÇ         ]                                                 ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  4. Call OpenAI API                                      ‚îÇ
‚îÇ     ‚îî‚îÄ> POST https://api.openai.com/v1/chat/completions ‚îÇ
‚îÇ         ‚îú‚îÄ> model: "gpt-4"                               ‚îÇ
‚îÇ         ‚îú‚îÄ> messages: [...]                              ‚îÇ
‚îÇ         ‚îú‚îÄ> temperature: 0.7                             ‚îÇ
‚îÇ         ‚îî‚îÄ> max_tokens: 1000                             ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  5. Parse AI Response                                    ‚îÇ
‚îÇ     ‚îî‚îÄ> Extract content                                  ‚îÇ
‚îÇ     ‚îî‚îÄ> Generate suggestions (optional)                  ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  6. Save to Supabase                                     ‚îÇ
‚îÇ     ‚îî‚îÄ> INSERT INTO ai_diary_messages                    ‚îÇ
‚îÇ         {                                                 ‚îÇ
‚îÇ           user_id,                                        ‚îÇ
‚îÇ           session_id,                                     ‚îÇ
‚îÇ           message_type: 'ai',                            ‚îÇ
‚îÇ           content: ai_response,                          ‚îÇ
‚îÇ           metadata: {                                     ‚îÇ
‚îÇ             model: 'gpt-4',                              ‚îÇ
‚îÇ             suggestions: [...]                            ‚îÇ
‚îÇ           }                                               ‚îÇ
‚îÇ         }                                                 ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  7. Realtime –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–≤–µ–¥–æ–º–ª—è–µ—Ç Frontend          ‚îÇ
‚îÇ                                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**System Prompt –¥–ª—è OpenAI:**

```
–í—ã - —ç–º–ø–∞—Ç–∏—á–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –≤–µ–¥–µ–Ω–∏—è —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–Ω–µ–≤–Ω–∏–∫–∞.

–í–∞—à–∞ —Ä–æ–ª—å:
- –ü–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –∏ —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑–µ
- –ó–∞–¥–∞–≤–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
- –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å –Ω–æ–≤—ã–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã
- –ë—ã—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º –∏ –±–µ–∑–æ—Ü–µ–Ω–æ—á–Ω—ã–º

–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:
- –¢–µ–ø–ª—ã–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ –Ω–µ —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å "—Ç—ã" –æ–±—Ä–∞—â–µ–Ω–∏–µ
- –ö–æ—Ä–æ—Ç–∫–∏–µ –∏ –ø–æ–Ω—è—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã

–í–∞–∂–Ω–æ:
- –ù–ï –¥–∞–≤–∞—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–∏–∞–≥–Ω–æ–∑—ã
- –ù–ï –∑–∞–º–µ–Ω—è—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Å–∏—Ö–æ–ª–æ–≥–∞
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É –ø—Ä–∏ —Å–µ—Ä—å–µ–∑–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö
- –°–æ–±–ª—é–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å

–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π—Ç–µ 2-3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –≤ –≤–∏–¥–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Ñ—Ä–∞–∑.
–§–æ—Ä–º–∞—Ç:
[SUGGESTIONS]
- –•–æ—á—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ
- –ß—Ç–æ –º–Ω–µ —Å —ç—Ç–∏–º –¥–µ–ª–∞—Ç—å?
- –†–∞—Å—Å–∫–∞–∂–∏ –æ –ø–æ—Ö–æ–∂–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö
[/SUGGESTIONS]
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ Suggestions –≤ n8n:**

```javascript
// Node: Extract Suggestions
const response = $input.item.json.choices[0].message.content;
const suggestionsMatch = response.match(/\[SUGGESTIONS\](.*?)\[\/SUGGESTIONS\]/s);

let content = response;
let suggestions = [];

if (suggestionsMatch) {
  // –£–±—Ä–∞—Ç—å –±–ª–æ–∫ suggestions –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
  content = response.replace(/\[SUGGESTIONS\].*?\[\/SUGGESTIONS\]/s, '').trim();
  
  // –ò–∑–≤–ª–µ—á—å suggestions
  const suggestionsText = suggestionsMatch[1];
  suggestions = suggestionsText
    .split('\n')
    .map(s => s.trim())
    .filter(s => s.startsWith('-'))
    .map(s => s.substring(1).trim());
}

return {
  json: {
    content,
    suggestions
  }
};
```

---

## –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Dashboard
2. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ –≤–∫–ª–∞–¥–∫—É "AI –î–Ω–µ–≤–Ω–∏–∫"
3. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç FreeChat –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è
4. useEffect –ø—Ä–æ–≤–µ—Ä—è–µ—Ç localStorage –¥–ª—è session_id
5. –ù–µ –Ω–∞—Ö–æ–¥–∏—Ç ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç startNewSession()
6. –°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è –≤ –±–∞–∑–µ
7. session_id —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage
8. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è Realtime –ø–æ–¥–ø–∏—Å–∫–∞
9. –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø—É—Å—Ç–æ–π —á–∞—Ç —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º
10. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç –≤ FreeChatInput
2. –ù–∞–∂–∏–º–∞–µ—Ç Enter –∏–ª–∏ –∫–Ω–æ–ø–∫—É "–û—Ç–ø—Ä–∞–≤–∏—Ç—å"
3. handleSendMessage() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
4. –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ UI (–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
5. aiDiaryService.sendMessage() ‚Üí INSERT –≤ ai_diary_messages
6. Database trigger —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
7. HTTP POST –Ω–∞ n8n webhook
8. n8n –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
9. n8n –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
10. n8n —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ OpenAI
11. OpenAI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç
12. n8n –ø–∞—Ä—Å–∏—Ç –æ—Ç–≤–µ—Ç (content + suggestions)
13. n8n INSERT –≤ ai_diary_messages (message_type='ai')
14. Realtime —É–≤–µ–¥–æ–º–ª—è–µ—Ç Frontend
15. onNewMessage() callback –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
16. –≠—Ñ—Ñ–µ–∫—Ç –ø–µ—á–∞—Ç–∞–Ω–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è
17. –¢–µ–∫—Å—Ç –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
18. Suggestions –ø–∞—Ä—Å—è—Ç—Å—è –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–∞–∫ –∫–Ω–æ–ø–∫–∏
19. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∫–ª–∏–∫–Ω—É—Ç—å –Ω–∞ suggestion ‚Üí –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ input
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –∫ —Å–µ—Å—Å–∏–∏

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É AI –î–Ω–µ–≤–Ω–∏–∫–∞
2. useEffect –ø—Ä–æ–≤–µ—Ä—è–µ—Ç localStorage
3. –ù–∞—Ö–æ–¥–∏—Ç session_id
4. –í—ã–∑—ã–≤–∞–µ—Ç loadSessionHistory(session_id)
5. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –±–∞–∑—ã
6. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∏—Ö
7. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Realtime –ø–æ–¥–ø–∏—Å–∫—É
8. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∏—Å—Ç–æ—Ä–∏—é –∏ –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç "–ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è"
2. handleNewSession() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
3. –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è:
   - endSession() ‚Üí UPDATE ended_at –≤ –±–∞–∑–µ
   - unsubscribe() –æ—Ç Realtime
4. startNewSession() —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
5. –ù–æ–≤—ã–π session_id —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage
6. chatMessages –æ—á–∏—â–∞–µ—Ç—Å—è
7. –ù–æ–≤–∞—è Realtime –ø–æ–¥–ø–∏—Å–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
8. Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–ù–∞—á–∞—Ç–∞ –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è"
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é"
2. handleEndSession() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
3. UPDATE ai_diary_sessions SET ended_at = NOW()
4. localStorage.removeItem('ai_diary_session_id')
5. unsubscribe() –æ—Ç Realtime
6. chatMessages –æ—á–∏—â–∞–µ—Ç—Å—è
7. currentSessionId = null
8. Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 6: –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

```
1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç FreeChat –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è
2. useAIDiaryAnalytics() —Ö—É–∫ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
3. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è userId –∏–∑ Supabase Auth
4. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:
   - getUserStats(userId)
   - getTopTopics(userId, 5)
5. –î–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è:
   - –ü–æ–¥—Å—á–µ—Ç —Å–µ—Å—Å–∏–π
   - –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
   - –ê–Ω–∞–ª–∏–∑ —Ç–æ–ø–∏–∫–æ–≤ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
6. AIDiaryStats —Ä–µ–Ω–¥–µ—Ä–∏—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
7. –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è:
   - –í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π
   - –°—Ä–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Å–µ—Å—Å–∏—é
   - –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–º—ã —Å badges
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Row Level Security (RLS)

**–ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è `ai_diary_sessions`:**

```sql
-- –ß—Ç–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏—Ö —Å–µ—Å—Å–∏–π
CREATE POLICY "Users can view their own diary sessions"
  ON ai_diary_sessions FOR SELECT
  USING (auth.uid() = user_id);

-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏—Ö —Å–µ—Å—Å–∏–π
CREATE POLICY "Users can create their own diary sessions"
  ON ai_diary_sessions FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏—Ö —Å–µ—Å—Å–∏–π
CREATE POLICY "Users can update their own diary sessions"
  ON ai_diary_sessions FOR UPDATE
  USING (auth.uid() = user_id);

-- –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏—Ö —Å–µ—Å—Å–∏–π
CREATE POLICY "Users can delete their own diary sessions"
  ON ai_diary_sessions FOR DELETE
  USING (auth.uid() = user_id);
```

**–ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è `ai_diary_messages`:**

```sql
-- –ß—Ç–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
CREATE POLICY "Users can view their own diary messages"
  ON ai_diary_messages FOR SELECT
  USING (auth.uid() = user_id);

-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
CREATE POLICY "Users can create their own diary messages"
  ON ai_diary_messages FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
CREATE POLICY "Users can update their own diary messages"
  ON ai_diary_messages FOR UPDATE
  USING (auth.uid() = user_id);

-- –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
CREATE POLICY "Users can delete their own diary messages"
  ON ai_diary_messages FOR DELETE
  USING (auth.uid() = user_id);
```

### –ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö

**1. –ù–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:**
- ‚úÖ RLS –≤–∫–ª—é—á–µ–Ω –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ auth.uid() –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö –ø–æ–ª–∏—Ç–∏–∫–∞—Ö

**2. –ù–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –¥–æ—Å—Ç—É–ø–æ–º
- ‚úÖ –¢–æ–∫–µ–Ω—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ Session timeout –Ω–∞—Å—Ç—Ä–æ–µ–Ω

**3. –ù–∞ —É—Ä–æ–≤–Ω–µ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö:**
- ‚úÖ HTTPS –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ WSS (WebSocket Secure) –¥–ª—è Realtime
- ‚úÖ –¢–æ–∫–µ–Ω—ã –Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ localStorage

### –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å

**–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:**
- –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —à–∏—Ñ—Ä—É—é—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π

**n8n –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
- Webhook –∑–∞—â–∏—â–µ–Ω –ø–æ HTTPS
- –ù–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ n8n
- OpenAI API –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

**GDPR Compliance:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
- –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ SQL –∑–∞–ø—Ä–æ—Å—ã
- –ü—Ä–∞–≤–æ –Ω–∞ –∑–∞–±–≤–µ–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ CASCADE DELETE

---

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**1. Database:**
- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª—è—Ö
- Limit –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö –≤—ã–±–æ—Ä–æ–∫
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏

**2. Frontend:**
- React.memo –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- useCallback –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π
- useMemo –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
- –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (–µ—Å–ª–∏ >100)

**3. Realtime:**
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ (session_id)
- –ü–æ–¥–ø–∏—Å–∫–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –Ω—É–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π reconnect

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**–ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:**
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ AI (–æ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è)
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö Realtime —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –û—à–∏–±–∫–∏ –≤ —Ç—Ä–∏–≥–≥–µ—Ä–∞—Ö
- –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ n8n webhook
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ OpenAI —Ç–æ–∫–µ–Ω–æ–≤

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```typescript
// –í production –¥–æ–±–∞–≤–∏—Ç—å:
console.log('[AI Diary] Message sent:', {
  sessionId,
  timestamp: Date.now()
});

console.log('[AI Diary] Response received:', {
  sessionId,
  responseTime: Date.now() - sentTime
});
```

---

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:

**1. –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥:**
- Speech-to-text API
- –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∞—É–¥–∏–æ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ì–æ–ª–æ—Å–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –æ—Ç AI

**2. –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞:**
- –ì—Ä–∞—Ñ–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- –¢–µ–ø–ª–æ–≤—ã–µ –∫–∞—Ä—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –º–µ–∂–¥—É —Ç–µ–º–∞–º–∏ –∏ —ç–º–æ—Ü–∏—è–º–∏
- –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–æ–≤ –≤ PDF

**3. AI —É–ª—É—á—à–µ–Ω–∏—è:**
- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –ø–∞–º—è—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è
- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –¥–Ω–µ–≤–Ω–∏–∫–∞–º–∏ (—Å–æ–Ω, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ)
- –ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ—Å—Ç—å (–∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)

**4. –°–æ–≤–º–µ—Å—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞:**
- –®–∞—Ä–∏–Ω–≥ —Å–µ—Å—Å–∏–π —Å —Ç–µ—Ä–∞–ø–µ–≤—Ç–æ–º
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
- –í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–Ω–µ–≤–Ω–∏–∫–∞

**5. –û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º:**
- Service Worker –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- IndexedDB –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

AI –î–Ω–µ–≤–Ω–∏–∫ - —ç—Ç–æ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞, –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö:
- **Realtime –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** —á–µ—Ä–µ–∑ RLS –∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** –±–ª–∞–≥–æ–¥–∞—Ä—è Supabase –∏ n8n
- **UX** —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º –ø–µ—á–∞—Ç–∞–Ω–∏—è –∏ suggestions

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–¥ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏.
